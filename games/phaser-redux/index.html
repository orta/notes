<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/notes/styles.81f02c45f5b6bd8f00e1.css" data-identity="gatsby-global-css">:root{--toc-width:200px;--toc-cur-highlight-color:#000;--toc-text-color:inherit;--toc-text-hover-color:#666}.toc{overflow-y:auto}.toc>.toc-list{overflow:hidden;position:relative}.toc>.toc-list li{list-style:none}.toc-list{margin:0;padding-left:10px}a.toc-link{color:var(--toc-text-color);height:100%}a.toc-link:hover{color:var(--toc-text-hover-color)}.is-collapsible{max-height:1000px;overflow:hidden;transition:all .3s ease-in-out}.is-collapsed{max-height:0}.tocbot.is-position-fixed{position:fixed;right:1em;top:100px;z-index:100}.is-active-link{font-weight:700}.toc-link:before{background-color:#eee;content:" ";display:inline-block;height:inherit;left:0;margin-top:-1px;position:absolute;width:2px}.tocbot ol:not(.toc-list){list-style:none;padding-left:1em}.is-active-link:before{background-color:var(--toc-cur-highlight-color)}


/*! tailwindcss v2.0.4 | MIT License | https://tailwindcss.com */

/*! modern-normalize v1.0.0 | MIT License | https://github.com/sindresorhus/modern-normalize */:root{-moz-tab-size:4;-o-tab-size:4;tab-size:4}html{line-height:1.15}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji}button,input{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button{text-transform:none}[type=button],button{-webkit-appearance:button}summary{display:list-item}h1,h2,h3,h4,h5,h6,p{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}ul{list-style:none;margin:0}html{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}body{font-family:inherit;line-height:inherit}*,:after,:before{border:0 solid #e5e7eb;box-sizing:border-box}input::-moz-placeholder{color:#9ca3af;opacity:1}input:-ms-input-placeholder{color:#9ca3af;opacity:1}input::placeholder{color:#9ca3af;opacity:1}button{cursor:pointer}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input{color:inherit;line-height:inherit;padding:0}object,svg{display:block;vertical-align:middle}.flex{display:flex}.hidden{display:none}.flex-col{flex-direction:column}.items-center{align-items:center}.justify-between{justify-content:space-between}.flex-grow{flex-grow:1}.flex-shrink-0{flex-shrink:0}.font-semibold{font-weight:600}.h-screen{height:100vh}.text-lg{font-size:1.125rem;line-height:1.75rem}.mr-2{margin-right:.5rem}.min-h-screen{min-height:100vh}.p-5{padding:1.25rem}.px-2{padding-left:.5rem;padding-right:.5rem}.py-3{padding-bottom:.75rem;padding-top:.75rem}.py-5{padding-bottom:1.25rem;padding-top:1.25rem}.px-5{padding-left:1.25rem;padding-right:1.25rem}.px-7{padding-left:1.75rem;padding-right:1.75rem}.fixed{position:fixed}.relative{position:relative}.resize{resize:both}*{--tw-shadow:0 0 #0000}.hover\:shadow-md:hover,.shadow-md{--tw-shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}*{--tw-ring-inset:var(--tw-empty,/*!*/ /*!*/);--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000}.w-3\/12{width:25%}.w-screen{width:100vw}.z-10{z-index:10}.z-20{z-index:20}.transition-all{transition-duration:.15s;transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1)}@-webkit-keyframes spin{to{transform:rotate(1turn)}}@keyframes spin{to{transform:rotate(1turn)}}@keyframes ping{75%,to{opacity:0;transform:scale(2)}}@keyframes pulse{50%{opacity:.5}}@keyframes bounce{0%,to{-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1);transform:translateY(-25%)}50%{-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1);transform:none}}@media (min-width:768px){.md\:flex{display:flex}.md\:hidden{display:none}.md\:h-screen{height:100vh}.md\:m-auto{margin:auto}.md\:overflow-y-auto{overflow-y:auto}}@media (min-width:1024px){.lg\:block{display:block}}:scope{--light-1:#f9fafb;--light-2:#f3f4f6;--light-3:#e7e5e4;--light-4:#fff;--dark-1:#2e3440;--dark-2:#3b4252;--dark-3:#434c5e;--dark-4:#4c566a;--frost1:#8fbcbb;--frost2:#88c0d0;--frost3:#a1c4e6;--frost4:#81a1c1;--red:#bf616a;--orange:#d08770;--yellow:#ebcb8b;--green:#a3be8c;--purple:#b48ead}body{--kb-link-color:#ff5449;--kb-tree-cur-color:#e7e5e4;--kb-font-family:"Avenir",-apple-system,sans-serif;--kb-shadow-bg:rgba(0,0,0,0.2);--kb-text-color:#2e1f1f;--kb-text-inverse-color:#fff;--kb-references-bg:#fafafa;--kb-search-highlight-bg:#eaeaea;--kb-note-bg:var(--bg-color-1);--kb-separator-color:#ddd;--kb-scrollbar-thumb:#ddd;--kb-blockquote-bg:#f6f6f6;--bg-color-1:#f9fafb;--bg-color-2:#f3f4f6;--code-bg-color:#f0f0f0;--code-color:#333}@media (min-width:1024px){::-webkit-scrollbar{height:8px;width:8px}::-webkit-scrollbar-thumb{background-color:var(--kb-scrollbar-thumb);border-radius:10px}}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;box-sizing:border-box;overflow-y:overlay}body{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;word-wrap:break-word;-ms-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt";background-color:var(--bg-color-2);color:var(--kb-text-color);font-family:var(--kb-font-family);-webkit-font-kerning:normal;font-kerning:normal;font-weight:400;margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent;color:var(--kb-link-color)}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help;text-decoration:none}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{text-rendering:optimizeLegibility;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-size:2.25rem;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none;margin:0 0 1.45rem;max-width:100%;padding:0}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace;font-size:1em}figure{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;box-sizing:content-box;height:1px;margin:0 0 calc(1.45rem - 1px);overflow:visible;padding:0}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 0 1.45rem;padding:0}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}*,:after,:before{box-sizing:inherit}h2{font-size:1.62671rem}h2,h3{text-rendering:optimizeLegibility;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0}h3{font-size:1.38316rem}h4{font-size:1rem}h4,h5{text-rendering:optimizeLegibility;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0}h5{font-size:.85028rem}h6{text-rendering:optimizeLegibility;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-size:.78405rem;font-weight:700;line-height:1.1}h6,hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem;padding:0}dd,dl,p{padding:0}dd,dl,p,pre{margin:0 0 1.45rem}pre{word-wrap:normal;background:rgba(0,0,0,.04);border-radius:3px;line-height:1.42;overflow:auto;padding:1rem}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;margin:0 0 1.45rem;padding:0;width:100%}blockquote{background-color:var(--kb-blockquote-bg);border-left:2px solid var(--kb-text-color);margin-bottom:1.45rem;padding:1.45rem}address,form,iframe,noscript{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code{line-height:1.45rem}kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}td,th,thead{text-align:left}td,th{font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:var(--code-bg-color);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em .3em}pre code{background:none;line-height:1.42;padding:0}code{color:var(--code-color)}@media only screen and (max-width:480px){html{font-size:100%}}.dark-mode{--kb-link-color:var(--frost3);--kb-tree-cur-color:var(--dark-3);--kb-font-family:"Avenir",-apple-system,sans-serif;--kb-shadow-bg:rgba(0,0,0,0.2);--kb-text-color:#eceff4;--kb-text-inverse-color:#fff;--kb-references-bg:var(--dark-2);--kb-search-highlight-bg:var(--dark-3);--kb-separator-color:#666;--kb-scrollbar-thumb:var(--dark-4);--kb-blockquote-bg:#353c48;--bg-color-1:var(--dark-1);--bg-color-2:var(--dark-2);--code-bg-color:var(--dark-2);--code-color:var(--purple)}body{--toc-text-hover-color:var(--kb-link-color);--toc-cur-highlight-color:var(--kb-text-color)}.tocbot{font-size:.9rem}.tocbot li{margin-bottom:0}.toc-link:before{background-color:transparent;height:1.4em}.toc-link.is-active-link:before{background-color:var(--toc-cur-highlight-color)}.header{align-items:center;display:flex;justify-content:space-between;padding:10px 15px}.layout__content{margin:auto;max-width:960px}.anchor-tag__popover{background-color:var(--kb-references-bg);border-radius:.5rem;box-shadow:0 1px 3px var(--kb-shadow-bg);max-height:26rem;max-width:26rem;overflow:auto;overflow:overlay;padding:1rem;position:relative}.anchor-tag__popover.no-max-width{max-width:90vw}.anchor-tag__popover.with-markdown{font-size:.875rem}.anchor-tag__popover h1,.anchor-tag__popover h2,.anchor-tag__popover h3,.anchor-tag__popover h4,.anchor-tag__popover h5,.anchor-tag__popover h6{font-size:1rem;margin-bottom:5px;padding:0}.anchor-tag__popover blockquote{margin-bottom:0;margin-left:0;padding:0}.anchor-tag__popover ul{margin-bottom:0;margin-left:0;padding-left:1rem}.anchor-tag__popover li{margin-bottom:0}.tippy-box[data-animation=shift-away][data-state=hidden]{opacity:0}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=top]{transform:translateY(10px)}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=bottom]{transform:translateY(-10px)}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=left]{transform:translateX(10px)}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=right]{transform:translateX(-10px)}.link-refernce__context{padding-left:1em}.topic ol,.topic ul{list-style:inherit}.topic__references{background-color:var(--kb-blockquote-bg);padding:1em}.dark-mode pre.shiki{-webkit-filter:invert(98%) hue-rotate(180deg);filter:invert(98%) hue-rotate(180deg)}ol li{list-style:decimal}.orta li{margin-bottom:1rem}pre{background-color:#fff;border-bottom:1px solid #999;border-left:1px solid #999;color:#000;margin-bottom:3rem;padding:12px;position:relative}pre,pre.shiki{overflow-x:auto}pre.shiki:hover .dim{opacity:1}pre.shiki div.dim{opacity:.5}pre.shiki div.dim,pre.shiki div.highlight{margin:0;padding:0}pre.shiki div.highlight{background-color:#f1f8ff;opacity:1}pre.shiki div.line{min-height:1rem}pre.shiki .language-id{display:none}pre.twoslash{border-color:#719af4}pre.twoslash:hover data-lsp{border-color:#747474}pre.twoslash data-lsp:hover:before{background-color:#3f3f3f;border-radius:2px;color:#fff;content:attr(lsp);font-family:JetBrains Mono,Menlo,Monaco,Consolas,Courier New,monospace;font-size:14px;padding:5px 8px;position:absolute;text-align:left;transform:translateY(1rem);white-space:pre-wrap;z-index:100}pre .code-container{overflow:auto}pre .code-container>a{border:1px solid #719af4;border-radius:4px;bottom:8px;color:#719af4;opacity:0;padding:0 8px;position:absolute;right:8px;text-decoration:none;transition-timing-function:ease;transition:opacity .3s}@media (prefers-reduced-motion:reduce){pre .code-container>a{transition:none}}pre .code-container>a:hover{background-color:#719af4;color:#fff}pre .code-container:hover a{opacity:1}pre code{-webkit-overflow-scrolling:touch;font-family:JetBrains Mono,Menlo,Monaco,Consolas,Courier New,monospace;font-size:15px;white-space:pre}pre code a{text-decoration:none}pre data-err{background:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 6 3'%3E%3Cg fill='%23c94824'%3E%3Cpolygon points='5.5 0 2.5 3 1.1 3 4.1 0'/%3E%3Cpolygon points='4 0 6 2 6 .6 5.4 0'/%3E%3Cpolygon points='0 2 1 3 2.4 3 0 .6'/%3E%3C/g%3E%3C/svg%3E") repeat-x 0 100%;padding-bottom:3px}pre .query{color:#137998;display:inline-block;margin-bottom:10px}pre .error,pre .error-behind{display:block;margin-bottom:4px;margin-left:-14px;margin-top:8px;padding:6px 6px 6px 14px;white-space:pre-wrap;width:calc(100% - 20px)}pre .error{align-items:center;background-color:#fee;border-left:2px solid #bf1818;color:#000;display:flex;position:absolute}pre .error .code{display:none}pre .error-behind{color:#fee;user-select:none;visibility:transparent}pre .arrow{background-color:#eee;border-left:1px solid #eee;border-top:1px solid #eee;height:8px;margin-left:.1rem;position:relative;top:-7px;transform:translateY(25%) rotate(45deg);width:8px}pre .popover{background-color:#eee;border-radius:3px;display:inline-block;margin-bottom:10px;margin-top:10px;padding:0 .5rem .3rem}pre .inline-completions ul.dropdown{background-color:#dcdcdc;border-left:4px solid #4b9edd;color:grey;display:inline-block;font-family:var(--code-font);font-size:.8rem;margin:0;padding:0;position:absolute;width:240px}pre .inline-completions ul.dropdown:before{background-color:#4b9edd;content:" ";left:-3px;position:absolute;top:-1.2rem;width:2px}pre .inline-completions ul.dropdown li{margin-bottom:4px;overflow-x:hidden;padding-left:4px}pre .inline-completions ul.dropdown li.deprecated{text-decoration:line-through}pre .inline-completions ul.dropdown li span.result-found{color:#4b9edd}pre .inline-completions ul.dropdown li span.result{color:#000;display:inline-block;width:100px}.dark-theme .markdown pre{background-color:#d8d8d8;border-color:#ddd;filter:invert(98%) hue-rotate(180deg)}data-lsp{border-bottom:1px dotted transparent;transition-timing-function:ease;transition:border-color .3s}@media (prefers-reduced-motion:reduce){data-lsp{transition:none}}.code-title{float:right}.topic-layout__main{max-width:100%;width:1480px}.topic-layout__content{background-color:var(--kb-note-bg);max-width:min(960px,100vw)}.topic-layout__left{background-color:var(--bg-color-2);position:relative;transition:box-shadow .3s ease-in-out;width:280px}.topic-layout__left--mobile{left:0;position:fixed;top:0;transform:translateX(-280px)}.topic-layout__left--mobile.topic-layout__left--show{transform:translateX(0)}.topic-layout__right{overflow-x:hidden;transition:box-shadow .3s ease-in-out;width:280px}.topic-layout__left,.topic-layout__right{height:100vh;overflow-y:auto}.topic-layout .tocbot{margin-top:20px}.topic-layout__header{background-color:var(--bg-color-2);position:sticky;top:0}.topic-layout__right .dark-mode-toggle{margin-top:.6em}.topic-layout__mask{background-color:rgba(0,0,0,.1)}.graph-button{align-items:center;background:none;border:0;cursor:pointer;display:flex}.graph-button:hover{fill:var(--kb-link-color);color:var(--kb-link-color)}.graph-button__hint{margin-left:5px}.graph-button svg{fill:var(--kb-text-color)}.tree-view ul,ul.tree-view{margin:0}.tree-view__node{margin-bottom:0;margin-left:0;padding-left:10px}.tree-view__node-header{cursor:pointer;display:inline-block;width:100%}.tree-view__node-header:hover{color:var(--kb-link-color)}.tree-view__icon{margin-left:-5px;margin-right:2px;position:relative;top:-1px;transition:transform .2s ease}.tree-view__icon--expanded{transform:rotate(90deg)}.svg-icon{display:inline-block;width:1em}.searchWrapper{display:block;position:relative}.inputWrapper{color:var(--kb-text-color);position:relative}.inputWrapper .searchIcon{fill:var(--kb-text-color);left:2px;padding:2px 2px 0;pointer-events:none;position:absolute;width:22px}.inputWrapper:hover .searchIcon{fill:var(--kb-link-color)}.inputWrapper input{background-color:var(--kb-note-bg);border:1px solid transparent;color:var(--kb-text-color);height:26px;outline:none;padding-left:28px;width:100%}.inputWrapper input:focus{border-color:inherit}.results{-webkit-padding-start:0;background:var(--kb-note-bg);border-radius:4px;box-shadow:-5px -5px 15px -3px var(--kb-shadow-bg);display:block;margin-left:0;max-height:50vh;max-width:calc(100vw - 20px);overflow-y:auto;padding-inline-start:0;position:fixed;right:0;top:0;width:500px}.results li{border-bottom:1px solid var(--kb-separator-color);cursor:pointer;display:block;padding:10px 16px;text-decoration:none}.results li:hover{background:var(--kb-search-highlight-bg)}.results li .title{color:var(--kb-text-color);font-weight:700}.results li .excerpt{font-size:.9em}.lds-dual-ring:after{-webkit-animation:lds-dual-ring 1.2s ease-in-out infinite;animation:lds-dual-ring 1.2s ease-in-out infinite;border-color:var(--kb-separator-color);border-bottom:6px solid var(--kb-separator-color);border-left:6px solid transparent;border-radius:50%;border-right:6px solid transparent;border-top:6px solid var(--kb-separator-color);content:" ";display:block;height:64px;left:calc(50% - 32px);margin:8px;position:relative;width:64px}@-webkit-keyframes lds-dual-ring{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}@keyframes lds-dual-ring{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.site-sidebar{display:flex;flex-direction:column;width:100%}.site-sidebar__title{font-size:large;font-weight:700;margin-bottom:5px}.site-sidebar__title a{color:var(--kb-text-color)}.site-sidebar__title a:hover{color:var(--kb-link-color)}.site-sidebar__link{color:var(--kb-text-color);display:block}.site-sidebar__link:hover{color:var(--kb-link-color)}.site-sidebar__link--cur{background-color:var(--kb-tree-cur-color)}.site-sidebar__files{overflow-y:auto}.site-sidebar__search{margin:5px 15px 15px 0}.dark-mode-toggle{cursor:pointer;display:flex}.dark-mode-toggle input{display:none}.dark-mode-toggle input+div{border-radius:50%;box-shadow:inset 5px -5px 0 0 #fff;height:20px;position:relative;transform:scale(1) rotate(-2deg);transition:box-shadow .5s ease 0s,transform .4s ease .1s;width:20px}.dark-mode-toggle input+div:before{border-radius:inherit;content:"";height:inherit;left:0;position:absolute;top:0;transition:background .3s ease;width:inherit}.dark-mode-toggle input+div:after{border-radius:50%;box-shadow:0 -11px 0 var(--kb-text-color),0 11px 0 var(--kb-text-color),11px 0 0 var(--kb-text-color),-11px 0 0 var(--kb-text-color),8px 8px 0 var(--kb-text-color),-8px 8px 0 var(--kb-text-color),8px -8px 0 var(--kb-text-color),-8px -8px 0 var(--kb-text-color);content:"";height:4px;left:50%;margin:-2px 0 0 -2px;position:absolute;top:50%;transform:scale(0);transition:all .3s ease;width:4px}.dark-mode-toggle input:checked+div{box-shadow:inset 32px -32px 0 0 #fff;transform:scale(.5) rotate(0deg);transition:transform .3s ease .1s,box-shadow .2s ease 0s}.dark-mode-toggle input:checked+:before{background:var(--kb-text-color);transition:background .3s ease .1s}.dark-mode-toggle input:checked+:after{transform:scale(1.5);transition:transform .5s ease .15s}.dark-mode-toggle__hint{margin-left:5px}.dark-mode .force-graph-container canvas{background:#3b4352!important}.dark-mode .overlay{background-color:hsla(0,0%,39%,.3)}.dark-mode .modal-close{background-color:rgba(0,0,0,.4);border-radius:50%}.overlay{align-items:center;-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px);background-color:var(--kb-shadow-bg);bottom:0;display:flex;display:none;height:100%;justify-content:center;left:0;position:fixed;right:0;top:0;width:100%;z-index:98}.overlay.show{display:block}.graph-view__modal{align-items:center;background-color:var(--main-bg);border-radius:8px;box-shadow:-5px -5px 15px -3px var(--kb-shadow-bg),0 4px 6px -2px rgba(0,0,0,.05);display:flex;height:100%;justify-content:center;left:0;position:fixed;top:0;width:100%;z-index:99}.graph-view__search-wrap{margin-right:10px}.graph-view__search-wrap input{width:300px}.graph-view__search-results{z-index:200}.graph-view__modal-hint{color:var(--kb-text-inverse-color);font-size:1.5em;margin-top:.5em}.modal-close,.modal-scale{background:none;border:0;color:var(--kb-text-color);cursor:pointer;padding:5px;position:absolute;right:10px;top:10px}.modal-close svg,.modal-scale svg{height:20px;width:20px}.modal-close path,.modal-scale path{fill:currentColor}.modal-scale{right:30px}.modal-minimized .modal-close svg,.modal-minimized .modal-scale svg{height:15px;width:15px}.modal-minimized .modal-scale{right:25px}.modal-body{height:100%;width:100%}.modal-body .node,.modal-body .text{cursor:pointer}</style><meta name="generator" content="Gatsby 3.10.2"/><title data-react-helmet="true">An architecture for Phaser JS + Redux | Notes</title><meta data-react-helmet="true" name="description" content="A growing wiki of linked notes from @orta"/><meta data-react-helmet="true" property="og:title" content="An architecture for Phaser JS + Redux"/><meta data-react-helmet="true" property="og:description" content="A growing wiki of linked notes from @orta"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:creator" content="Orta Therox"/><meta data-react-helmet="true" name="twitter:title" content="An architecture for Phaser JS + Redux"/><meta data-react-helmet="true" name="twitter:description" content="A growing wiki of linked notes from @orta"/><meta data-react-helmet="true" property="twitter:domain" content="orta.io"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" property="og:image" content="https://orta.io/notes/games/phaser-redux/og-image.jpg"/><link as="script" rel="preload" href="/notes/webpack-runtime-9ac343c4689ebc09e4c0.js"/><link as="script" rel="preload" href="/notes/framework-286f7b2e5207e738a310.js"/><link as="script" rel="preload" href="/notes/app-decf3f5a50085e07f211.js"/><link as="script" rel="preload" href="/notes/4132111da32c6d5a24e7057e13fe2842d706d49e-4b440ca10d7f8bfdc78d.js"/><link as="script" rel="preload" href="/notes/component---node-modules-gatsby-theme-kb-src-templates-topic-js-10d20f918603c44ca99e.js"/><link as="fetch" rel="preload" href="/notes/page-data/games/phaser-redux/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/notes/page-data/sq/d/2221750479.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/notes/page-data/sq/d/2380733210.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/notes/page-data/sq/d/2768355698.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/notes/page-data/sq/d/63159454.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/notes/page-data/sq/d/847517413.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/notes/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="topic-layout flex flex-col min-h-screen"><div class="topic-layout__header w-screen py-3 px-5 flex justify-between text-lg font-semibold shadow-md md:hidden"><div class="flex items-center"><div class="topic-layout__menu-icon mr-2"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" width="24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></div><div class="topic-layout__header-title">Notes</div></div><div class="flex items-center"><label class="dark-mode-toggle" aria-label="Activate dark mode" title="Activate dark mode"><input type="checkbox" checked=""/><div></div></label></div></div><div class="topic-layout__main md:m-auto flex min-h-screen"><div class="topic-layout__left flex-shrink-0  md:flex hover:shadow-md"><div class="site-sidebar py-5 px-2"><div class="site-sidebar__title"><a href="/notes/">Notes</a></div><div class="site-sidebar__search"><div class="searchWrapper" role="combobox" aria-expanded="false" aria-haspopup="listbox" aria-labelledby="downshift-23-label"><div class="inputWrapper"><svg class="searchIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M23.111 20.058l-4.977-4.977c.965-1.52 1.523-3.322 1.523-5.251 0-5.42-4.409-9.83-9.829-9.83-5.42 0-9.828 4.41-9.828 9.83s4.408 9.83 9.829 9.83c1.834 0 3.552-.505 5.022-1.383l5.021 5.021c2.144 2.141 5.384-1.096 3.239-3.24zm-20.064-10.228c0-3.739 3.043-6.782 6.782-6.782s6.782 3.042 6.782 6.782-3.043 6.782-6.782 6.782-6.782-3.043-6.782-6.782z"></path></svg><input type="text" aria-autocomplete="list" aria-labelledby="downshift-23-label" autoComplete="off" value="" id="downshift-23-input" placeholder="Search..."/></div></div></div><div class="site-sidebar__files"><ul class="tree-view"></ul></div></div></div><main class="topic-layout__content flex-grow py-5 px-7 md:h-screen md:overflow-y-auto"><div class="orta"><div class="topic"><h1 id="An-architecture-for-Phaser-JS-+-Redux">An architecture for Phaser JS + Redux</h1><p>I&#x27;ve built a few games now with Phaser, and I think I&#x27;ve found a generally good mental groove for writing easily tested TypeScript games. In rough, user inputs trigger redux actions, which updates state, and optionally  triggering UI Updates from the game renderer.</p><h2 id="Goals">Goals</h2><p>Oddly enough, for some of the games I&#x27;m making I want to avoid tying <em>too closely</em> to the game engine. There&#x27;s a non-zero possibility that it will need to render the same game but in more than just a canvas ( e.g. a static svg) and so I want to keep as much logic in &#x27;plain old JS&#x27; - this disconnect of &#x27;game&#x27; from &#x27;renderer&#x27; is not a foreign concept (games working with openGL vs DirectX comes to mind) but this introduces a really important <a href="https://duckduckgo.com/?q=working+effectively+with+legacy+code">seam</a> for composition and testing.</p><h2 id="Terminology">Terminology</h2><ul><li><p><strong>Game Props</strong> - The parts of the game&#x27;s level setup which are constant. This ranges from game config (original version of the board, colour scheme, game mode settings etc)</p></li><li><p><strong>Game State</strong> - The parts of the game which change (moves made, words found, tiles removed, user selection states)</p></li><li><p><strong>Renderer</strong> - A way to display the current props + state, y&#x27;know, the game bit</p></li><li><p><strong>Redux</strong> - A state management library which constrains the set of places the games state can change into a single place. Renderers can subscribe to know when changes have been made.  </p></li><li><p><strong><a href="https://redux.js.org/api/store/">Redux Store</a></strong> - A five euro name for a 10 cents idea, it&#x27;s just the name of the db for the JSON and the API for subscriptions</p></li><li><p><strong><a href="https://redux.js.org/recipes/reducing-boilerplate#actions">Redux Actions</a></strong> - It is the renderer&#x27;s responsibility to tell the game engine that the state should change, this is done by sending redux actions into the games state. An action is basically a message sent to the store.</p></li></ul><h2 id="Overview">Overview</h2><p><img src="/notes/assets/img/game-loop.png" alt="A flow diagram of the upcoming text"/></p><h3 id="Setup">Setup</h3><p>Let&#x27;s take a game of <a href="http://playtypeshift.com/">Typeshift</a> as an example. That link will let you play the game too BTW.</p><p><img src="/notes/assets/img/typeshift.png" alt="pic of the game Typeshift"/></p><p>We&#x27;d need to start by having Props which look something like:</p><pre class="shiki github-light" style="background-color:#fff;color:#24292e"><div class="language-id">ts</div><div class="code-container"><code><div class="line"><span style="color:#D73A49">interface</span><span style="color:#24292E"> </span><span style="color:#6F42C1">GameProps</span><span style="color:#24292E"> {</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#E36209">style</span><span style="color:#D73A49">:</span><span style="color:#24292E"> { </span><span style="color:#E36209">text</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#005CC5">string</span><span style="color:#24292E">, </span><span style="color:#E36209">tileBG</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#005CC5">string</span><span style="color:#24292E">, </span><span style="color:#E36209">tileFoundBG</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#005CC5">string</span><span style="color:#24292E"> },</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#E36209">columns</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#6F42C1">Array</span><span style="color:#24292E">&lt;{ </span><span style="color:#E36209">letters</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#005CC5">string</span><span style="color:#24292E">[] }&gt;</span></div><div class="line"><span style="color:#24292E">}</span></div></code></div></pre><p>Then, because we know as you go through the game finding words and selecting letters, we&#x27;ll need some sort of way to describe the changes from the original baseline, where here I moved the first column down by one:</p><p><img src="/notes/assets/img/typeshift-2.png" alt="pic of the game Typeshift with words found"/></p><p>We&#x27;ll mix those props in with the changing settings:</p><pre class="shiki github-light" style="background-color:#fff;color:#24292e"><div class="language-id">ts</div><div class="code-container"><code><div class="line"><span style="color:#D73A49">interface</span><span style="color:#24292E"> </span><span style="color:#6F42C1">GameState</span><span style="color:#24292E"> {</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#6A737D">// Integer offset from center </span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#E36209">columnOffsets</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#005CC5">number</span><span style="color:#24292E">[]</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#6A737D">// E.g. what should be highlighted for keyboard input</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#E36209">selectedColumn</span><span style="color:#D73A49">?:</span><span style="color:#24292E"> </span><span style="color:#005CC5">number</span><span style="color:#24292E"> </span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#6A737D">// Tiles which have been found, goal is to get them all found</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#E36209">foundLetters</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#6F42C1">Position</span><span style="color:#24292E">[]</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#6A737D">// Words found in the process</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#E36209">foundWords</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#005CC5">string</span><span style="color:#24292E">[]</span></div><div class="line"></div><div class="line"><span style="color:#24292E">    </span><span style="color:#6A737D">// More on this later</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#E36209">uiUpdates</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#6F42C1">UIUpdate</span><span style="color:#24292E">[]</span></div><div class="line"><span style="color:#24292E">} </span><span style="color:#D73A49">&amp;</span><span style="color:#24292E"> GameProps</span></div></code></div></pre><p>So, to start up the game we&#x27;d need a way to grab or generate the props and state. Then this can be put into the <a href="https://redux.js.org/api/store">Redux store</a>. Once the store is ready, then you can create a renderer.</p><p> As we&#x27;re talking about Phaser, that means making a <a href="https://phaser.io/phaser3/contributing/part5">Phaser Scene</a> which subscribes to the Redux store.</p><pre class="shiki github-light" style="background-color:#fff;color:#24292e"><div class="language-id">ts</div><div class="code-container"><code><div class="line"><span style="color:#24292E">  </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#005CC5">props</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> </span><span style="color:#D73A49">await</span><span style="color:#24292E"> host.</span><span style="color:#6F42C1">getProps</span><span style="color:#24292E">()</span></div><div class="line"><span style="color:#24292E">  </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#005CC5">state</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> </span><span style="color:#D73A49">await</span><span style="color:#24292E"> host.</span><span style="color:#6F42C1">getState</span><span style="color:#24292E">()  </span></div><div class="line"><span style="color:#24292E">  </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#005CC5">store</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> </span><span style="color:#6F42C1">createGameStore</span><span style="color:#24292E">(props, state)</span></div><div class="line"></div><div class="line"><span style="color:#24292E">  </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#005CC5">scene</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> </span><span style="color:#D73A49">new</span><span style="color:#24292E"> </span><span style="color:#6F42C1">TypeshiftScene</span><span style="color:#24292E">(</span><span style="color:#032F62">&quot;main&quot;</span><span style="color:#24292E">, { store })</span></div><div class="line"><span style="color:#24292E">  </span></div><div class="line"><span style="color:#24292E">  </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#005CC5">config</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#6F42C1">Phaser</span><span style="color:#24292E">.</span><span style="color:#6F42C1">Types</span><span style="color:#24292E">.</span><span style="color:#6F42C1">Core</span><span style="color:#24292E">.</span><span style="color:#6F42C1">GameConfig</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> {</span></div><div class="line"><span style="color:#24292E">    type: Phaser.</span><span style="color:#005CC5">AUTO</span><span style="color:#24292E">,</span></div><div class="line"><span style="color:#24292E">    width: </span><span style="color:#032F62">&quot;100%&quot;</span><span style="color:#24292E">,</span></div><div class="line"><span style="color:#24292E">    height: </span><span style="color:#032F62">&quot;100%&quot;</span><span style="color:#24292E">,</span></div><div class="line"><span style="color:#24292E">    backgroundColor: </span><span style="color:#032F62">&quot;#fac24f&quot;</span><span style="color:#24292E">,</span></div><div class="line"><span style="color:#24292E">    parent: </span><span style="color:#032F62">&quot;game&quot;</span><span style="color:#24292E">,</span></div><div class="line"><span style="color:#24292E">    scene: [scene],</span></div><div class="line"><span style="color:#24292E">  }</span></div><div class="line"></div><div class="line"><span style="color:#24292E">  </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#005CC5">game</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> </span><span style="color:#D73A49">new</span><span style="color:#24292E"> Phaser.</span><span style="color:#6F42C1">Game</span><span style="color:#24292E">(config)</span></div><div class="line"><span style="color:#24292E">  </span><span style="color:#6A737D">// @ts-ignore</span></div><div class="line"><span style="color:#24292E">  window.game </span><span style="color:#D73A49">=</span><span style="color:#24292E"> game</span></div></code></div></pre><p>This is pretty vanilla, all Phaser games would end up with something like this. The only specifics are that it delegates grabbing <code>props</code> and <code>state</code> to a host object which could be anything (e.g. maybe there&#x27;s a Daily host which gives the same props every day and uses localstorage for state) </p><p>Next let&#x27;s look at the <code>TypeshiftScene</code>, it&#x27;s a Phaser Scene subclass which encapsulates creating the UI, and keeps references to all those objects. Here they are encapsulated in <code>Column</code> objects. The key to think about is launching the game, setting up input and then subscribing to upcoming state changes.</p><pre class="shiki github-light" style="background-color:#fff;color:#24292e"><div class="language-id">ts</div><div class="code-container"><code><div class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> { animationsDone, SpellTowerState, SpellTowerStore } </span><span style="color:#D73A49">from</span><span style="color:#24292E"> </span><span style="color:#032F62">&quot;../index&quot;</span></div><div class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> </span><span style="color:#D73A49">type</span><span style="color:#24292E"> { PossibleUIChanges } </span><span style="color:#D73A49">from</span><span style="color:#24292E"> </span><span style="color:#032F62">&quot;./updates/types&quot;</span></div><div class="line"></div><div class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> { setupKeyboardInput } </span><span style="color:#D73A49">from</span><span style="color:#24292E"> </span><span style="color:#032F62">&quot;./input/keyboardInput&quot;</span></div><div class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> { setupMouseInput } </span><span style="color:#D73A49">from</span><span style="color:#24292E"> </span><span style="color:#032F62">&quot;./input/mouseInput&quot;</span></div><div class="line"></div><div class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> { Column } </span><span style="color:#D73A49">from</span><span style="color:#24292E"> </span><span style="color:#032F62">&quot;./objects/Column&quot;</span></div><div class="line"></div><div class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> { columnsUpdated } </span><span style="color:#D73A49">from</span><span style="color:#24292E"> </span><span style="color:#032F62">&quot;./updates/columnsUpdated&quot;</span></div><div class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> { resetSelection, selectionUpdated } </span><span style="color:#D73A49">from</span><span style="color:#24292E"> </span><span style="color:#032F62">&quot;./updates/selectionUpdate&quot;</span></div><div class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> { commitSelectionUpdated } </span><span style="color:#D73A49">from</span><span style="color:#24292E"> </span><span style="color:#032F62">&quot;./updates/commitSelectionUpdate&quot;</span></div><div class="line"></div><div class="line"></div><div class="line"><span style="color:#D73A49">export</span><span style="color:#24292E"> </span><span style="color:#D73A49">let</span><span style="color:#24292E"> TypeshiftScene </span><span style="color:#D73A49">=</span><span style="color:#24292E"> </span><span style="color:#D73A49">class</span><span style="color:#24292E"> </span><span style="color:#6F42C1">TypeshiftSceneClass</span><span style="color:#24292E"> </span><span style="color:#D73A49">extends</span><span style="color:#24292E"> </span><span style="color:#D73A49">extends</span><span style="color:#24292E"> </span><span style="color:#6F42C1">Phaser</span><span style="color:#24292E">.</span><span style="color:#6F42C1">Scene</span><span style="color:#24292E"> {</span></div><div class="line"><span style="color:#24292E">  </span><span style="color:#E36209">store</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#6F42C1">TypeshiftStore</span></div><div class="line"><span style="color:#24292E">  </span><span style="color:#E36209">columns</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#6F42C1">Column</span><span style="color:#24292E">[]</span></div><div class="line"></div><div class="line"><span style="color:#24292E">  </span><span style="color:#6F42C1">create</span><span style="color:#24292E">() {</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#6A737D">// Interactions</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#6F42C1">setupKeyboardInput</span><span style="color:#24292E">(</span><span style="color:#005CC5">this</span><span style="color:#24292E">)</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#6F42C1">setupMouseInput</span><span style="color:#24292E">(</span><span style="color:#005CC5">this</span><span style="color:#24292E">)</span></div><div class="line"></div><div class="line"><span style="color:#24292E">    </span><span style="color:#6A737D">// Setup column UI and then &quot;reset&quot; to the current state</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#005CC5">state</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> </span><span style="color:#005CC5">this</span><span style="color:#24292E">.store.</span><span style="color:#6F42C1">getState</span><span style="color:#24292E">()</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#005CC5">this</span><span style="color:#24292E">.columns </span><span style="color:#D73A49">=</span><span style="color:#24292E"> state.columns.</span><span style="color:#6F42C1">map</span><span style="color:#24292E">((</span><span style="color:#E36209">c</span><span style="color:#24292E">, </span><span style="color:#E36209">i</span><span style="color:#24292E">) </span><span style="color:#D73A49">=&gt;</span><span style="color:#24292E"> </span><span style="color:#D73A49">new</span><span style="color:#24292E"> </span><span style="color:#6F42C1">Column</span><span style="color:#24292E">(</span><span style="color:#005CC5">this</span><span style="color:#24292E">, i))</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#005CC5">this</span><span style="color:#24292E">.columns.</span><span style="color:#6F42C1">forEach</span><span style="color:#24292E">(</span><span style="color:#E36209">c</span><span style="color:#24292E"> </span><span style="color:#D73A49">=&gt;</span><span style="color:#24292E"> </span><span style="color:#005CC5">this</span><span style="color:#24292E">.add.</span><span style="color:#6F42C1">existing</span><span style="color:#24292E">(c))</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#6F42C1">resetSelection</span><span style="color:#24292E">(</span><span style="color:#005CC5">this</span><span style="color:#24292E">, state)</span></div><div class="line"></div><div class="line"><span style="color:#24292E">    </span><span style="color:#6A737D">// Start listening for changes </span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#005CC5">this</span><span style="color:#24292E">.state.store.</span><span style="color:#6F42C1">subscribe</span><span style="color:#24292E">(() </span><span style="color:#D73A49">=&gt;</span><span style="color:#24292E"> </span><span style="color:#005CC5">this</span><span style="color:#24292E">.</span><span style="color:#6F42C1">stateUpdated</span><span style="color:#24292E">())</span></div><div class="line"><span style="color:#24292E">  }</span></div><div class="line"></div><div class="line"><span style="color:#24292E">  </span><span style="color:#6F42C1">stateUpdated</span><span style="color:#24292E">() {</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#005CC5">newState</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> </span><span style="color:#005CC5">this</span><span style="color:#24292E">.store.</span><span style="color:#6F42C1">getState</span><span style="color:#24292E">()</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#6A737D">// Do we need to make changes?</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#D73A49">if</span><span style="color:#24292E"> (</span><span style="color:#D73A49">!</span><span style="color:#24292E">newState.ui.</span><span style="color:#005CC5">length</span><span style="color:#24292E">) </span><span style="color:#D73A49">return</span></div><div class="line"></div><div class="line"><span style="color:#24292E">    </span><span style="color:#6A737D">// Trigger UIActions, then empty the actions array</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#D73A49">for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#005CC5">action</span><span style="color:#24292E"> </span><span style="color:#D73A49">of</span><span style="color:#24292E"> newState.ui) {</span></div><div class="line"><span style="color:#24292E">      updates[action[</span><span style="color:#032F62">&quot;type&quot;</span><span style="color:#24292E">]](</span><span style="color:#005CC5">this</span><span style="color:#24292E">, newState, action)</span></div><div class="line"><span style="color:#24292E">    }</span></div><div class="line"></div><div class="line"><span style="color:#24292E">    </span><span style="color:#005CC5">this</span><span style="color:#24292E">.store.</span><span style="color:#6F42C1">dispatch</span><span style="color:#24292E">(</span><span style="color:#6F42C1">animationsDone</span><span style="color:#24292E">())</span></div><div class="line"><span style="color:#24292E">  }</span></div><div class="line"><span style="color:#24292E">}</span></div><div class="line"></div><div class="line"><span style="color:#6A737D">// A set of UI actions which handles the UI for state changes in Phaser</span></div><div class="line"><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#005CC5">updates</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#6F42C1">Record</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">PossibleUIChanges</span><span style="color:#24292E">, (</span><span style="color:#E36209">game</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#6F42C1">TypeshiftSceneGame</span><span style="color:#24292E">, </span><span style="color:#E36209">state</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#6F42C1">GameState</span><span style="color:#24292E">, </span><span style="color:#E36209">action</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#005CC5">any</span><span style="color:#24292E">) </span><span style="color:#D73A49">=&gt;</span><span style="color:#24292E"> </span><span style="color:#6F42C1">Promise</span><span style="color:#24292E">&lt;</span><span style="color:#005CC5">void</span><span style="color:#24292E"> </span><span style="color:#D73A49">|</span><span style="color:#24292E"> </span><span style="color:#005CC5">unknown</span><span style="color:#24292E">&gt;&gt; </span><span style="color:#D73A49">=</span><span style="color:#24292E"> {</span></div><div class="line"><span style="color:#24292E">  columns_updated: columnsUpdated,</span></div><div class="line"><span style="color:#24292E">  selection_changed: selectionUpdated,</span></div><div class="line"><span style="color:#24292E">  commit_selection: commitSelectionUpdated,</span></div><div class="line"><span style="color:#24292E">}</span></div><div class="line"></div><div class="line"><span style="color:#D73A49">export</span><span style="color:#24292E"> </span><span style="color:#D73A49">type</span><span style="color:#24292E"> </span><span style="color:#6F42C1">TypeshiftSceneGame</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> </span><span style="color:#6F42C1">InstanceType</span><span style="color:#24292E">&lt;</span><span style="color:#D73A49">typeof</span><span style="color:#24292E"> TypeshiftScene&gt;</span></div></code></div></pre><h3 id="Waiting-for-Input">Waiting for Input</h3><p>So, from that original diagram, we&#x27;re now at the &quot;waiting for input phase&quot;. The game doesn&#x27;t do anything at this point unless the user specifically does something. Let&#x27;s look at <code>registerKeyboardInput</code> as that is the simplest input function. This function uses the Phaser API for keyboard input to listen to browser events and then will convert those into actions in the Redux store.</p><pre class="shiki github-light" style="background-color:#fff;color:#24292e"><div class="language-id">ts</div><div class="code-container"><code><div class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> { TypeshiftSceneGame, TypeshiftStore, down, left, right, up } </span><span style="color:#D73A49">from</span><span style="color:#24292E"> </span><span style="color:#032F62">&quot;../../index&quot;</span></div><div class="line"></div><div class="line"><span style="color:#D73A49">export</span><span style="color:#24292E"> </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#005CC5">keycodes</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> {</span></div><div class="line"><span style="color:#24292E">  left: </span><span style="color:#005CC5">37</span><span style="color:#24292E">,</span></div><div class="line"><span style="color:#24292E">  a: </span><span style="color:#005CC5">65</span><span style="color:#24292E">,</span></div><div class="line"><span style="color:#24292E">  right: </span><span style="color:#005CC5">39</span><span style="color:#24292E">,</span></div><div class="line"><span style="color:#24292E">  d: </span><span style="color:#005CC5">68</span><span style="color:#24292E">,</span></div><div class="line"><span style="color:#24292E">  up: </span><span style="color:#005CC5">38</span><span style="color:#24292E">,</span></div><div class="line"><span style="color:#24292E">  w: </span><span style="color:#005CC5">87</span><span style="color:#24292E">,</span></div><div class="line"><span style="color:#24292E">  down: </span><span style="color:#005CC5">40</span><span style="color:#24292E">,</span></div><div class="line"><span style="color:#24292E">  s: </span><span style="color:#005CC5">83</span><span style="color:#24292E">,</span></div><div class="line"><span style="color:#24292E">}</span></div><div class="line"></div><div class="line"><span style="color:#D73A49">export</span><span style="color:#24292E"> </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#6F42C1">registerKeyboardInput</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (</span><span style="color:#E36209">game</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#6F42C1">TypeshiftSceneGame</span><span style="color:#24292E">) </span><span style="color:#D73A49">=&gt;</span><span style="color:#24292E"> {</span></div><div class="line"><span style="color:#24292E">  </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#005CC5">store</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> game.state.store</span></div><div class="line"><span style="color:#24292E">  </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#005CC5">kbd</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> game.input.keyboard</span></div><div class="line"><span style="color:#24292E">  kbd.</span><span style="color:#6F42C1">addCapture</span><span style="color:#24292E">(</span><span style="color:#032F62">&quot;W,S,A,D,UP,DOWN,LEFT,RIGHT&quot;</span><span style="color:#24292E">)</span></div><div class="line"><span style="color:#24292E">  </span></div><div class="line"><span style="color:#24292E">  kbd.</span><span style="color:#6F42C1">on</span><span style="color:#24292E">(</span><span style="color:#032F62">&quot;keyup&quot;</span><span style="color:#24292E">, (</span><span style="color:#E36209">event</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#6F42C1">KeyboardEvent</span><span style="color:#24292E">) </span><span style="color:#D73A49">=&gt;</span><span style="color:#24292E"> {</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#D73A49">if</span><span style="color:#24292E"> (event.keyCode </span><span style="color:#D73A49">===</span><span style="color:#24292E"> keycodes.left </span><span style="color:#D73A49">||</span><span style="color:#24292E"> event.keyCode </span><span style="color:#D73A49">===</span><span style="color:#24292E"> keycodes.a) {</span></div><div class="line"><span style="color:#24292E">      store.</span><span style="color:#6F42C1">dispatch</span><span style="color:#24292E">(</span><span style="color:#6F42C1">left</span><span style="color:#24292E">())</span></div><div class="line"><span style="color:#24292E">    } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> </span><span style="color:#D73A49">if</span><span style="color:#24292E"> (event.keyCode </span><span style="color:#D73A49">===</span><span style="color:#24292E"> keycodes.right </span><span style="color:#D73A49">||</span><span style="color:#24292E"> event.keyCode </span><span style="color:#D73A49">===</span><span style="color:#24292E"> keycodes.d) {</span></div><div class="line"><span style="color:#24292E">      store.</span><span style="color:#6F42C1">dispatch</span><span style="color:#24292E">(</span><span style="color:#6F42C1">right</span><span style="color:#24292E">())</span></div><div class="line"><span style="color:#24292E">    } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> </span><span style="color:#D73A49">if</span><span style="color:#24292E"> (event.keyCode </span><span style="color:#D73A49">===</span><span style="color:#24292E"> keycodes.down </span><span style="color:#D73A49">||</span><span style="color:#24292E"> event.keyCode </span><span style="color:#D73A49">===</span><span style="color:#24292E"> keycodes.s) {</span></div><div class="line"><span style="color:#24292E">      store.</span><span style="color:#6F42C1">dispatch</span><span style="color:#24292E">(</span><span style="color:#6F42C1">down</span><span style="color:#24292E">())</span></div><div class="line"><span style="color:#24292E">    } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> </span><span style="color:#D73A49">if</span><span style="color:#24292E"> (event.keyCode </span><span style="color:#D73A49">===</span><span style="color:#24292E"> keycodes.up </span><span style="color:#D73A49">||</span><span style="color:#24292E"> event.keyCode </span><span style="color:#D73A49">===</span><span style="color:#24292E"> keycodes.w) {</span></div><div class="line"><span style="color:#24292E">      store.</span><span style="color:#6F42C1">dispatch</span><span style="color:#24292E">(</span><span style="color:#6F42C1">up</span><span style="color:#24292E">())</span></div><div class="line"><span style="color:#24292E">    }</span></div><div class="line"><span style="color:#24292E">  }</span></div><div class="line"><span style="color:#24292E">}</span></div></code></div></pre><h3 id="Update-State">Update State</h3><p>Lets follow what happens when <code>up</code> is called, first to give you a sense of how the actions connect to the store, <code>up</code> is created in the same place as the Redux store. </p><pre class="shiki github-light" style="background-color:#fff;color:#24292e"><div class="language-id">ts</div><div class="code-container"><code><div class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> { configureStore, createAction, createReducer } </span><span style="color:#D73A49">from</span><span style="color:#24292E"> </span><span style="color:#032F62">&quot;@reduxjs/toolkit&quot;</span></div><div class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> { moveColumns } </span><span style="color:#D73A49">from</span><span style="color:#24292E"> </span><span style="color:#032F62">&quot;./src/actions/moveColumns&quot;</span></div><div class="line"></div><div class="line"><span style="color:#D73A49">export</span><span style="color:#24292E"> </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#005CC5">up</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> </span><span style="color:#6F42C1">createAction</span><span style="color:#24292E">(</span><span style="color:#032F62">&quot;UP&quot;</span><span style="color:#24292E">)</span></div><div class="line"></div><div class="line"><span style="color:#D73A49">export</span><span style="color:#24292E"> </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#6F42C1">createGameStore</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (</span><span style="color:#E36209">initialState</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#6F42C1">GameState</span><span style="color:#24292E">) </span><span style="color:#D73A49">=&gt;</span><span style="color:#24292E"> {</span></div><div class="line"><span style="color:#24292E">  </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#005CC5">reducer</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> </span><span style="color:#6F42C1">createReducer</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">SpellTowerState</span><span style="color:#24292E">&gt;(initialState, {</span></div><div class="line"><span style="color:#24292E">    [up.type]: </span><span style="color:#E36209">state</span><span style="color:#24292E"> </span><span style="color:#D73A49">=&gt;</span><span style="color:#24292E"> </span><span style="color:#6F42C1">moveColumns</span><span style="color:#24292E">(state, up.type),</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#6A737D">// Lots more here ...</span></div><div class="line"><span style="color:#24292E">  })</span></div><div class="line"></div><div class="line"><span style="color:#24292E">  </span><span style="color:#D73A49">return</span><span style="color:#24292E"> </span><span style="color:#6F42C1">configureStore</span><span style="color:#24292E">({ reducer })</span></div><div class="line"><span style="color:#24292E">}</span></div></code></div></pre><p>This setup means when code like this is called:</p><pre class="shiki github-light" style="background-color:#fff;color:#24292e"><div class="language-id">ts</div><div class="code-container"><code><div class="line"><span style="color:#24292E">store.</span><span style="color:#6F42C1">dispatch</span><span style="color:#24292E">(</span><span style="color:#6F42C1">up</span><span style="color:#24292E">())</span></div></code></div></pre><p>It becomes the responsibility of <code>moveColumns</code> to edit the app&#x27;s state, and to let the renderer know what sort of changes it should make to the UI:</p><pre class="shiki github-light" style="background-color:#fff;color:#24292e"><div class="language-id">ts</div><div class="code-container"><code><div class="line"><span style="color:#D73A49">export</span><span style="color:#24292E"> </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#6F42C1">moveColumns</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (</span><span style="color:#E36209">state</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#6F42C1">GameState</span><span style="color:#24292E">, </span><span style="color:#E36209">dir</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#6F42C1">Direction</span><span style="color:#24292E">) </span><span style="color:#D73A49">=&gt;</span><span style="color:#24292E"> {</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#6A737D">// Select the first one if there&#x27;s no selection</span></div><div class="line"><span style="color:#24292E">  </span><span style="color:#D73A49">if</span><span style="color:#24292E"> (</span><span style="color:#D73A49">!</span><span style="color:#24292E">state.selectedColumn) {</span></div><div class="line"><span style="color:#24292E">    state.selected </span><span style="color:#D73A49">=</span><span style="color:#24292E"> </span><span style="color:#005CC5">0</span></div><div class="line"><span style="color:#24292E">  }</span></div><div class="line"><span style="color:#24292E"> </span></div><div class="line"><span style="color:#24292E">  </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#005CC5">i</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> state.selected</span></div><div class="line"><span style="color:#24292E">  </span><span style="color:#D73A49">if</span><span style="color:#24292E"> (dir </span><span style="color:#D73A49">===</span><span style="color:#24292E"> </span><span style="color:#032F62">&quot;UP&quot;</span><span style="color:#24292E">) {</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#6A737D">// Can&#x27;t move further up  </span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#D73A49">if</span><span style="color:#24292E"> (state.columnTileOffset[i] </span><span style="color:#D73A49">===</span><span style="color:#24292E"> state.columns[i].characters.</span><span style="color:#005CC5">length</span><span style="color:#24292E"> </span><span style="color:#D73A49">-</span><span style="color:#24292E"> </span><span style="color:#005CC5">1</span><span style="color:#24292E">) </span><span style="color:#D73A49">return</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#6A737D">// Bump the offset by one</span></div><div class="line"><span style="color:#24292E">    state.columnTileOffset[i]</span><span style="color:#D73A49">++</span></div><div class="line"><span style="color:#24292E">  }</span></div><div class="line"></div><div class="line"><span style="color:#24292E">  state.ui.</span><span style="color:#6F42C1">push</span><span style="color:#24292E">({ type: </span><span style="color:#032F62">&quot;columns_updated&quot;</span><span style="color:#24292E"> })</span></div><div class="line"><span style="color:#24292E">  </span></div><div class="line"><span style="color:#24292E">  </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#005CC5">found</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> </span><span style="color:#6F42C1">checkForWordFound</span><span style="color:#24292E">(state)</span></div><div class="line"><span style="color:#24292E">  </span><span style="color:#D73A49">if</span><span style="color:#24292E"> (found) {</span></div><div class="line"><span style="color:#24292E">    state.ui.</span><span style="color:#6F42C1">push</span><span style="color:#24292E">({ type: </span><span style="color:#032F62">&quot;word_found&quot;</span><span style="color:#24292E"> })</span></div><div class="line"><span style="color:#24292E">  }</span></div><div class="line"><span style="color:#24292E">}</span></div></code></div></pre><p>When this function is finished, the store of the app is updated with the new state and any parts of the app which are set to listen to the store (our <code>TypeshiftSceneClass</code> did this via <code>this.state.store.subscribe</code>) will start their update cycle.</p><h3 id="UIUpdates">UIUpdates</h3><p>Now, in a React codebase we have the virtual DOM and the React reconciler. The reconciler&#x27;s job is to look at the current state of the DOM and the virtual DOM and handle the transformation from <em>where it was</em> to <em>where it should be</em>. I <em>could</em> try build a Phaser VDOM reconciler (it has <a href="https://github.com/evilfer/react-phaser">been explored</a>) but the UIUpdates is an acceptable hack to work around not having that tool.</p><p>So roughly, the UIUpdates is a way to scope &quot;changes&quot; to the Phaser DOM (Objects, Sprites, Text, Tiles etc) and handle all the state changes relating to a certain scope.</p><pre class="shiki github-light" style="background-color:#fff;color:#24292e"><div class="language-id">ts</div><div class="code-container"><code><div class="line"><span style="color:#D73A49">export</span><span style="color:#24292E"> </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#6F42C1">columnsUpdated</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> </span><span style="color:#D73A49">async</span><span style="color:#24292E"> (</span><span style="color:#E36209">game</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#6F42C1">TypeshiftSceneGame</span><span style="color:#24292E">, </span><span style="color:#E36209">state</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#6F42C1">GameState</span><span style="color:#24292E">, </span><span style="color:#E36209">action</span><span style="color:#D73A49">:</span><span style="color:#24292E"> </span><span style="color:#6F42C1">ColumnsUpdate</span><span style="color:#24292E">) </span><span style="color:#D73A49">=&gt;</span><span style="color:#24292E"> {</span></div><div class="line"><span style="color:#24292E">  game.columns.</span><span style="color:#6F42C1">forEach</span><span style="color:#24292E">((</span><span style="color:#E36209">col</span><span style="color:#24292E">, </span><span style="color:#E36209">i</span><span style="color:#24292E">) </span><span style="color:#D73A49">=&gt;</span><span style="color:#24292E"> {</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#005CC5">midY</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> game.scale.gameSize.height </span><span style="color:#D73A49">/</span><span style="color:#24292E"> </span><span style="color:#005CC5">2</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#005CC5">selectedTileIndex</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> state.columnOffsets[i]</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#005CC5">selectionOffset</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> selectedTileIndex </span><span style="color:#D73A49">*</span><span style="color:#24292E"> sizes.tileSize </span><span style="color:#D73A49">+</span><span style="color:#24292E"> selectedTileIndex </span><span style="color:#D73A49">*</span><span style="color:#24292E"> sizes.tileMargin</span></div><div class="line"><span style="color:#24292E">    </span><span style="color:#D73A49">const</span><span style="color:#24292E"> </span><span style="color:#005CC5">newY</span><span style="color:#24292E"> </span><span style="color:#D73A49">=</span><span style="color:#24292E"> midY </span><span style="color:#D73A49">-</span><span style="color:#24292E"> selectionOffset </span><span style="color:#D73A49">-</span><span style="color:#24292E"> sizes.tileSize</span></div><div class="line"></div><div class="line"><span style="color:#24292E">    </span><span style="color:#D73A49">if</span><span style="color:#24292E"> (col.y </span><span style="color:#D73A49">!==</span><span style="color:#24292E"> newY) </span><span style="color:#6F42C1">setYAnimated</span><span style="color:#24292E">(game, animate, col, newY)</span></div><div class="line"><span style="color:#24292E">  })</span></div><div class="line"><span style="color:#24292E">}</span></div></code></div></pre><p>In this case, the responsibility for this function is to dive into the <code>game</code>&#x27;s &#x27;internals&#x27; aka the exposed Phaser DOM on the class of the <code>TypeshiftSceneGame</code> and set the Y position of the columns according to the (now updated) state.</p><p>I spent some time thinking about whether uiactions should be async to handle chaining transitions for animations, and <em>so far</em> have not needed it. We&#x27;ll see whether that holds.</p><h3 id="Flow">Flow</h3><p>So, let&#x27;s try go over this one more time in short:</p><ul><li>Get props (unchanging per level) and state (things which change over time)</li><li>We start up a redux store with both the props and state</li><li>Create a renderer (phaser) which listens to changes in the store</li><li>Set up the renderer based on the new state</li><li>The renderer is responsible for setting up user-input</li><li>User input <em>eventually</em> triggers a redux action to update the game&#x27;s state</li><li>The game state is updated inside the redux store via action functions</li><li>If any of these state changes requires a UI change, then the state includes a list of UI updates</li><li>Run any UI updates which make renderer changes</li></ul><p>This might feel pretty abstract for small-ish games, but it allows for:</p><ul><li>It avoids a <em>massive</em> single Phaser Scene where state changes occurs from many places</li><li>Many possible renderers sharing most of the code</li><li>Many seams for writing tests without relying on very high level integration tests</li><li>A pretty obvious structure for where for most code in a game can live</li><li>Re-using existing redux tooling</li></ul><p>This architecture is built for games which require user input for the next thing to happen, I don&#x27;t think something like this would be a good fit for Flappy Royale for example (~100 birds realtime flapping through pipes concurrently ) where a runloop with scoped state is probably a better fit.  </p><p>Related: You can see an example of how I use a text renderer for game state in <a href="/notes/tests/inline-snapshots" title="tests/inline-snapshots">[[tests/inline-snapshots]]</a>.</p><h2 id="Yeah-but-why-Redux">Yeah, but why Redux?</h2><p>I didn&#x27;t just create this architecture ahead of time by cleverly analyzing what I needed and got it right, it took writing two games where they both kept heading in this direction till eventually I started formalizing and backported the architecture to the projects.</p><p>In the last ~5 years, I&#x27;ve wrote quite a lot of React-ish code, and see a lot of value in the explicit narrowing of state changes through as tight a function as possible.  </p><p>The first game had an explicit <code>setState</code> function on the Phaser Scene class which handled both state updates and ui updates. This was mixed with a multi-cast delegate pattern which allowed for many subscribers to know that the state had changed. I used this to allow for things like analytics, host callbacks and dev tooling.</p><p>This pattern worked pretty well though it started to hit issues when the number of responsibilities started to grow in that <code>setState</code> function, trying to keep it readable and focused meant moving a lot of useful internals out into sub-functions which often meant breaking the OOP contracts in those functions.</p><p>So I knew that a home-grown state mangement system was doable, but maybe I should formalize. I spent a day auditing the state of different state management systems by making quick apps and trying to deep dive in to their docs. The contenders were MobX, Vuex, Redux, Recoil and Jotai.</p><p>In part, it was made much easier because a few of these are strongly tied to a UI library to the point where they can&#x27;t be used without it ( Recoil, Vuex and Jotai ) which really only left MobX vs Redux. I have a bit of an aversion to reactive programming after building a non-trivial iOS app in RX, but I was open to at least seeing what was going on.</p><p>After trying both, I concluded that there&#x27;s a lot of MobX&#x27;s value which I would not use. I expected to mostly have a pretty small state object, but I could see that from the current architecture I could drop the UIActions abstraction in favour of having a renderer listen to changes in the state tree.</p><p>What went against MobX was the feeling that introducing reactive programming in one aspect of an app has a tendency to leak into all parts eventually, and I&#x27;m wary of that.</p><p>Redux won me over by being very small and extremely well documented. The core dependency was enough to get started but very quickly I realized I was re-creating the <a href="https://redux.js.org/redux-toolkit/overview">Redux Toolkit</a> and I should just lift my abstraction to that. Things I like:</p><ul><li>These sections of the docs: <a href="https://redux.js.org/redux-toolkit/overview">&quot;Thinking in Redux&quot;</a>, <a href="https://redux.js.org/tutorials/essentials/part-1-overview-concepts">&quot;Redux Essentials&quot;</a>, <a href="https://redux.js.org/style-guide/style-guide">&quot;Style Guide&quot;</a></li><li>The TypeScript support after switching to Redux Toolkit was very tight</li><li>Redux Toolkit uses immer to force immutablility</li><li>Redux Devtools is way better than my version</li><li>Massive community, got answers in Discord almost instantly</li></ul><p>Like all tools, you can get very complicated with your usage of Redux - but that&#x27;s usually the cost of doing complex things. I think in these games I&#x27;m getting enough value to pay for it&#x27;s abstraction costs and raw additions in kb. Aside from a deterministic random number generator, this is the only dependency I use outside of the renderer Phaser/svg.js.</p><div class="topic__references"><h2 id="Backlinks">Backlinks</h2><div><div class="link-reference"><a href="/notes/tests/inline-snapshots">Jest Inline Snapshots</a><div class="link-refernce__context">For a game I'm working on, I use Redux as a state management library [[games/phaser-redux]] and have an extensive Jest test suite around this code because it's all so self-contained. Games are particularly stateful apps, and relying on tests to handle all your logic usually saves a bunch of time because you don't have to get the game back into the same state as before. </div></div></div></div></div></div></main><div class="topic-layout__right flex-shrink-0 p-5 hidden lg:block hover:shadow-md"><div title="Show Graph Visualisation" aria-label="Show Graph Visualisation" class="graph-button"><span>
<svg
  t="1607341341241"
  class="icon"
  viewBox="0 0 1024 1024"
  version="1.1"
  xmlns="http://www.w3.org/2000/svg"
  width="20"
  height="20"
>
  <path d="M512 512m-125.866667 0a125.866667 125.866667 0 1 0 251.733334 0 125.866667 125.866667 0 1 0-251.733334 0Z"></path>
  <path d="M512 251.733333m-72.533333 0a72.533333 72.533333 0 1 0 145.066666 0 72.533333 72.533333 0 1 0-145.066666 0Z"></path>
  <path d="M614.4 238.933333c0 4.266667 2.133333 8.533333 2.133333 12.8 0 19.2-4.266667 36.266667-12.8 51.2 81.066667 36.266667 138.666667 117.333333 138.666667 211.2C742.4 640 640 744.533333 512 744.533333s-230.4-106.666667-230.4-232.533333c0-93.866667 57.6-174.933333 138.666667-211.2-8.533333-14.933333-12.8-32-12.8-51.2 0-4.266667 0-8.533333 2.133333-12.8-110.933333 42.666667-189.866667 147.2-189.866667 273.066667 0 160 130.133333 292.266667 292.266667 292.266666S804.266667 672 804.266667 512c0-123.733333-78.933333-230.4-189.866667-273.066667z"></path>
  <path d="M168.533333 785.066667m-72.533333 0a72.533333 72.533333 0 1 0 145.066667 0 72.533333 72.533333 0 1 0-145.066667 0Z"></path>
  <path d="M896 712.533333m-61.866667 0a61.866667 61.866667 0 1 0 123.733334 0 61.866667 61.866667 0 1 0-123.733334 0Z"></path>
  <path d="M825.6 772.266667c-74.666667 89.6-187.733333 147.2-313.6 147.2-93.866667 0-181.333333-32-249.6-87.466667-10.666667 19.2-25.6 34.133333-44.8 44.8C298.666667 942.933333 401.066667 981.333333 512 981.333333c149.333333 0 281.6-70.4 366.933333-177.066666-21.333333-4.266667-40.533333-17.066667-53.333333-32zM142.933333 684.8c-25.6-53.333333-38.4-110.933333-38.4-172.8C104.533333 288 288 104.533333 512 104.533333S919.466667 288 919.466667 512c0 36.266667-6.4 72.533333-14.933334 106.666667 23.466667 2.133333 42.666667 10.666667 57.6 25.6 12.8-42.666667 19.2-87.466667 19.2-132.266667 0-258.133333-211.2-469.333333-469.333333-469.333333S42.666667 253.866667 42.666667 512c0 74.666667 17.066667 142.933333 46.933333 204.8 14.933333-14.933333 32-27.733333 53.333333-32z"></path>
</svg>
</span><span class="graph-button__hint">Show Graph Visualisation</span></div><label class="dark-mode-toggle" aria-label="Activate dark mode" title="Activate dark mode"><input type="checkbox" checked=""/><div></div><span class="dark-mode-toggle__hint">Activate dark mode</span></label><div><div id="toc" class="toc tocbot js-toc"></div></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/games/phaser-redux";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-ba2adfb5f0062b3957b2.js"],"app":["/app-decf3f5a50085e07f211.js"],"component---node-modules-gatsby-theme-kb-src-pages-404-js":["/component---node-modules-gatsby-theme-kb-src-pages-404-js-313dca2310246bc11f82.js"],"component---node-modules-gatsby-theme-kb-src-templates-topic-js":["/component---node-modules-gatsby-theme-kb-src-templates-topic-js-10d20f918603c44ca99e.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-2b208f5f792f98e9e574.js"]};/*]]>*/</script><script src="/notes/polyfill-ba2adfb5f0062b3957b2.js" nomodule=""></script><script src="/notes/component---node-modules-gatsby-theme-kb-src-templates-topic-js-10d20f918603c44ca99e.js" async=""></script><script src="/notes/4132111da32c6d5a24e7057e13fe2842d706d49e-4b440ca10d7f8bfdc78d.js" async=""></script><script src="/notes/app-decf3f5a50085e07f211.js" async=""></script><script src="/notes/framework-286f7b2e5207e738a310.js" async=""></script><script src="/notes/webpack-runtime-9ac343c4689ebc09e4c0.js" async=""></script></body></html>